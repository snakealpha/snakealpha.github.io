---
layout: post
title: Unity3D 图形性能优化

tag: [译文, 图形]
categories: [Unity3D]

by-nc: true
---

<small>本文为Unity3D官方文档[Optimizing Graphics Performance](http://docs.unity3d.com/Manual/OptimizingGraphicsPerformance.html)的中文翻译。</small>

对于一款游戏的成功来说，好的性能总是至关重要。本文中包含了一些能够有效提升你的游戏性能的指导原则。

# 图形性能被耗在哪里？

你游戏中的图形部分主要会消耗两种系统资源：GPU和CPU。然而，由于针对GPU与CPU的优化策略大相径庭（甚至完全相反——为了优化CPU性能，你往往需要让GPU承担更多工作，反之亦然），对于任何优化行动，至关重要的第一步总是**定位性能问题的发生点**。

典型的性能瓶颈以及它们的判断方法包括：

- GPU往往受制于**填充率**和内存带宽。

- - 当你的游戏运行于较低的显示分辨率时，它是不是会跑的更快？如果是，你极有可能是受到了GPU填充率的制约。

- CPU准备渲染的过程（也就是**draw call**）常常限制性能。

- - 通过[Rendering Statistics](http://docs.unity3d.com/Manual/RenderingStatistics.html)窗口检查draw calls的数量；如果这个数字达到好几千（PC平台）抑或是好几百（移动平台），你就得优化一下对象的数量了。

当然，这只是一些概略的规则；其他地方也有可能出现瓶颈。一些不太常见的性能瓶颈还包括：

- 无论是对于CPU还是GPU，渲染本身都不是问题——你的代码和物理运算部分可能才是真正的问题所在。使用[Profiler](http://docs.unity3d.com/Manual/Profiler.html)分析代码，以找出问题所在。

- GPU需要处理太多的顶点。GPU处理顶点的能力取决于GPU本身的本身的素质以及顶点着色器的复杂程度。这方面常见的指导原则包括移动游戏**不要超过100k个定点**以及PC游戏**不要达到几M个顶点**。

- 有一些功能需要依赖CPU处理顶点，因此CPU需要处理的顶点过多也可能成为瓶颈。skinned mesh，布料模拟和粒子系统都需要依赖于CPU。

# CPU优化——抑制draw call

为了在屏幕上渲染物体，CPU也有一些工作要做，比如说确定影响物体的光源，设置着色器以及着色器参数，以及准备和发送绘图命令到图形驱动。CPU需要为**每个物体**完成这些工作，这并不轻松。要是你偏偏有很多可视的物体需要处理...那就更惨了。

因此，比如当你有几千个三角形需要处理的时候，相比于分别处理几千个各自只包含了一个三角形的网格，一次处理拥有几千个三角形的网格要高效得多。虽然对于GPU来说这两种情况基本是一回事，对CPU来说处理几千个物体的花销可就相当可观了。

为了减轻CPU的工作负担，减少可见物体的数量总是个好办法。比如做这些事试试：

- 将不会变动的物体合并。你可以手工去做，也可以借助Unity的[draw call batching](http://docs.unity3d.com/Manual/DrawCallBatching.html)功能。

- 在你的物体上使用尽量少种类的材质。通过把独立的贴图放到一个较大的贴图atlas里面，就可以做到这一点。

- 尽量少使用会导致物体渲染多次的功能（比如反射，阴影，每像素光照等。详见下文。）

可以通过合并物体使至少几百个三角形形成只使用一种**材质**的网格。务必记得合并两个并未共享同一材质的对象并不能使性能有所提升。最常见的多个物体不共享同一材质的原因在于，这些网格并没有使用相同的纹理。在这种情况下，要实现优化CPU性能的目的，你得确保你合并的所有网格使用了相同的纹理。

在[Forward渲染路径](http://docs.unity3d.com/Manual/RenderTech-ForwardRendering.html)中，如果使用多个像素光源，合并对象有可能没啥效果。下文会对此做出解释。

# GPU：几何建模优化

当试图优化一个模型的几何结构时，有两个基本原则：

- 不要使用多于必要的三角形。

- 尽量减少uv映射焊接和硬边缘（会消耗两倍的顶点数）的数量。

注意，图形硬件实际上需要处理的顶点数往往与3D应用汇报的数字不同。建模软件显示的通常只是几何上的顶点数。而对于显卡来说，一些结合顶点需要被分割成多个逻辑上的顶点才能完成渲染。如果一个顶点拥有多个法线，UV坐标或者顶点色参数，这个顶点就必须被拆分了。因此，Unity中显示的顶点数基本上会高于3D软件中给出的顶点数。

模型中的几何体大多是由CPU处理的，但是Unity中的一些功能需要使用CPU处理模型，比如网格皮肤。

# 光照性能

无需计算的光照是最快的！使用[光照贴图](http://docs.unity3d.com/Manual/Lightmapping.html)来"烘焙"静态光源的过程只需要进行一次，就能在每一帧里替代光照处理的计算。在Unity中生成一个光照贴图的工作只比单单将一个光源放到场景中麻烦一点点，**但是：**

- 这样程序能跑得快得多（在有两个像素光源的情况下，能快上2-3倍）

- 看上去效果也会更好——你可以烘焙全局光照，而烘焙工具会帮你平滑结果。

有很多简单的方法可以伪造出布设光源才能取得的效果（比如通过着色器，或是定制资源本身）。举例来说，如果需要轮廓照明的效果，可以不用真的添加一个直射摄像机的光源，只要直接在你的着色器里加上专用的"rim lighting"计算即可。
